<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <head>
        <!-- Meta tags for character set and responsive design -->
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Bootstrap CSS for styling -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link rel="stylesheet" th:href="@{/css/complaint-list.css}">

        <title>Srinivasa Refrigeration Works - Complaint List</title>
    </head>
    <body>
        <!-- Heading indicating the complaint list page -->
        <h3>Complaint List</h3> <br>

        <!-- Form to fetch complaint details based on the identifier -->
        <form th:action="@{/SRW/complaint/search}" th:object="${complaintIdentifierDTO}" method="POST">

            <!-- Identifier input field -->
            <input id="identifier" type="text" th:field="*{identifier}" placeholder="Enter complaint id or phone number">

            <!-- Registered date input field -->
            <input type="date" th:field="*{registeredDate}">

            <!-- Button to submit the form for fetching complaint details -->
            <input type="submit" class="btn btn-primary btn-sm mb-3" value="Search"> <br><br>

            <!-- Helper message providing guidance for input -->
            <p class="helper-message">Enter complaint ID or phone number. Add date if using phone number to fetch details.</p>
        </form>

        <!-- Display a message if no records are found -->
        <p th:if="${noComplaintsFound}" th:text="${noComplaintsFound}"></p>

        <!-- Display a table if there are complaints available -->
        <div th:if="${complaints}">

            <!-- Table structure for complaint details -->
            <table class="table table-bordered table-striped">
                <!-- Table header row -->
                <thead class="table-dark">
                <tr>
                    <!-- Table column headers for each complaint attribute -->
                    <th>Complaint ID</th>
                    <th>Customer Name</th>
                    <th>Phone Number</th>
                    <th>Email</th>
                    <th>Address</th>
                    <th>Product Type</th>
                    <th>Product Brand</th>
                    <th>Product Model</th>
                    <th>Issue</th>
                    <th>Creation Date</th>
                    <th>Status</th>
                    <th>Last Updated</th>
                    <th>Assigned To</th>
                    <th>Closure Date</th>
                    <th>Feedback</th>
                    <th>State</th>
                    <th>Manage</th>
                </tr>
                </thead>
                <tbody>
                <!-- Loop through complaints and display each record in the table -->
                <tr th:each="complaint : ${complaints}">
                    <!-- Display each complaint's data in the respective columns -->
                    <td th:text="${complaint.complaintId}"></td>
                    <td th:text="${complaint.customerName}"></td>
                    <td th:text="${complaint.contactNumber}"></td>
                    <!-- Display email or 'Not Provided' if email is not provided -->
                    <td th:text="${complaint.email != null ? complaint.email : 'Not Provided'}"></td>
                    <td th:text="${complaint.address}"></td>
                    <td th:text="${complaint.productType}"></td>
                    <td th:text="${complaint.brand}"></td>
                    <td th:text="${complaint.productModel}"></td>
                    <td th:text="${complaint.description}"></td>
                    <td th:text="${complaint.createdAt}"></td>
                    <td th:text="${complaint.status}"></td>
                    <!-- Display updated date or 'Not Updated Yet' if the complaint isn't updated -->
                    <td th:text="${complaint.updatedAt != null ? complaint.updatedAt : 'Not Updated Yet'}"></td>
                    <!-- Display technician info or 'Awaiting Technician' if not assigned -->
                    <td th:text="${complaint.technicianId != null ? complaint.technicianId : 'Awaiting Technician'}"></td>
                    <!-- Display closed date or 'Not Closed Yet' if the complaint isn't closed -->
                    <td th:text="${complaint.closedAt != null ? complaint.closedAt : 'Not Closed Yet'}"></td>
                    <!-- Display customer feedback or 'No Feedback' if not provided -->
                    <td th:text="${complaint.customerFeedback != null ? complaint.customerFeedback : 'No Feedback'}"></td>
                    <td th:text="${complaint.state}"></td> <!-- State -->
                    <td>
                        <!-- Update button with dynamic URL for complaint update -->
                        <a th:href="@{/SRW/complaint/update(complaintId=${complaint.complaintId})}" class="btn btn-info btn-sm">Update</a>

                        <!-- Check if user has the role 'OWNER' to display buttons -->
                        <div sec:authorize="hasRole('OWNER')">
                            <!-- Activate button visible only when state is IN_ACTIVE -->
                            <a th:if="${complaint.state.name() == 'IN_ACTIVE'}"
                               th:href="@{/SRW/complaint/activate(complaintId=${complaint.complaintId})}"
                               onclick="if(!(confirm('Are you sure activating the complaint?'))) return false"
                               class="btn btn-primary btn-sm">Activate</a>

                            <!-- Deactivate button visible only when state is ACTIVE -->
                            <a th:if="${complaint.state.name() == 'ACTIVE'}"
                               th:href="@{/SRW/complaint/deactivate(complaintId=${complaint.complaintId})}"
                               onclick="if(!(confirm('Are you sure deactivating the complaint?'))) return false"
                               class="btn btn-danger btn-sm">Deactivate</a>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Back to home link -->
        <a th:href="@{/SRW/home}" class="btn btn-danger btn-sm mb-3" title="Return to the homepage">Back to home</a>

        <!-- Check if user has the role 'OWNER' to display management portal -->
        <div sec:authorize="hasRole('OWNER')">
            <!-- Button to navigate to management portal -->
            <a th:href="@{/SRW/management-portal}" class="btn btn-secondary btn-sm mb-3" title="management portal">Back to Management Portal</a>
        </div>
    </body>
</html>